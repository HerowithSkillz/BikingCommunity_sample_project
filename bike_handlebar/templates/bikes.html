{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bikes - Biker Hub</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .hero {
        background: linear-gradient(90deg, rgba(34,193,195,0.08), rgba(253,187,45,0.04));
        padding: 2rem 1rem;
        border-radius: .5rem;
      }
      .biker-img { height: 140px; object-fit: cover; }
    </style>
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">Biker_hub</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navMenu">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="/">Bikes</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/">Events</a>
            </li>
          </ul>

          <div class="d-flex">
            {% if user %}
              <div class="me-3 d-flex align-items-center">
                <small class="text-muted">Signed in as <strong class="ms-1">{{ user }}</strong></small>
              </div>
              <a class="btn btn-outline-secondary" href="{% url 'logout_user' %}">Logout</a>
            {% else %}
              <a class="btn btn-outline-primary me-2" href="{% url 'login_user' %}">Login</a>
              <a class="btn btn-primary" href="{% url 'register_user' %}">Signup</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <section class="hero mb-4">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="display-6">Bikes directory</h1>
            <p class="lead">Browse bikes shared by the community. You can add, edit or remove bikes via the API.</p>
          </div>
        </div>
      </section>

      <section id="bikes-list">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5">Community Bikes</h2>
          <div>
            {% if user %}
            <button class="btn btn-sm btn-primary" id="openCreate">Add bike</button>
            {% endif %}
          </div>
        </div>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" id="cards">
          {% if bikes %}
            {% for b in bikes %}
            <div class="col">
              <div class="card h-100">
                <div class="card-body">
                  {% if user %}
                  <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-sm btn-outline-primary" data-id="{{ b.id }}" data-action="edit">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" data-id="{{ b.id }}" data-action="delete">Delete</button>
                  </div>
                  {% endif %}
                  <h5 class="card-title">{{ b.company|escape }} {{ b.model|escape }}</h5>
                  <p class="card-text">{{ b.description|default_if_none:""|escape }}</p>
                </div>
                <div class="card-footer text-muted small">Year: {{ b.year }}</div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <!-- cards injected by JS -->
          {% endif %}
        </div>

        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center" id="pagination">
            <!-- pagination buttons injected by JS -->
          </ul>
        </nav>
      </section>

      <!-- Create/Edit Modal -->
      <div class="modal fade" id="bikeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="bikeModalTitle">Add Bike</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="bikeForm">
                <input type="hidden" id="bikeId" />
                <div class="mb-3">
                  <label class="form-label">Company</label>
                  <input type="text" id="company" class="form-control" required />
                </div>
                <div class="mb-3">
                  <label class="form-label">Model</label>
                  <input type="text" id="model" class="form-control" required />
                </div>
                <div class="mb-3">
                  <label class="form-label">Year</label>
                  <input type="number" id="year" class="form-control" required />
                </div>
                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea id="description" class="form-control" rows="3"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="saveBike">Save</button>
            </div>
          </div>
        </div>
      </div>

      <footer class="border-top pt-3 pb-5 text-center small text-muted mt-5">
        © <span id="year"></span> Biker_hub — Connect. Ride. Share.
      </footer>
    </main>

    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      const API_BASE = 'http://127.0.0.1:8001/api/bikes/bikes/';
      let currentPageUrl = API_BASE;

      // Bootstrap modal
      const bikeModalEl = document.getElementById('bikeModal');
      const bikeModal = new bootstrap.Modal(bikeModalEl);

      document.getElementById('openCreate')?.addEventListener('click', () => {
        clearForm();
        document.getElementById('bikeModalTitle').textContent = 'Add Bike';
        bikeModal.show();
      });

      document.getElementById('saveBike').addEventListener('click', saveBike);

      async function loadBikes(url = API_BASE){
        try{
          currentPageUrl = url;
          const res = await fetch(url);
          if(!res.ok) throw new Error('Failed to load');
          const payload = await res.json();
          renderBikes(payload.results || payload);
          renderPagination(payload);
        }catch(e){
          console.error(e);
          document.getElementById('cards').innerHTML = '<div class="col"> <div class="alert alert-warning">Unable to load bikes. Ensure the API server (bike_fender) is running on port 8001.</div></div>'
        }
      }

      function renderBikes(bikes){
        const container = document.getElementById('cards');
        container.innerHTML = '';
        bikes.forEach(b => {
          const col = document.createElement('div'); col.className = 'col';
          const editControls = `{% if user %}` +
            `<div class="d-flex gap-2 mb-2">` +
              `<button class="btn btn-sm btn-outline-primary" data-id="${b.id}" data-action="edit">Edit</button>` +
              `<button class="btn btn-sm btn-outline-danger" data-id="${b.id}" data-action="delete">Delete</button>` +
            `</div>` +
          `{% endif %}`;

          col.innerHTML = `\
            <div class="card h-100">\
              <div class="card-body">\
                ${editControls}\
                <h5 class="card-title">${escapeHtml(b.company)} ${escapeHtml(b.model)}</h5>\
                <p class="card-text">${escapeHtml(b.description || '')}</p>\
              </div>\
              <div class="card-footer text-muted small">Year: ${b.year}</div>\
            </div>`;

          container.appendChild(col);
        });

        // attach event listeners for edit/delete
        container.querySelectorAll('button[data-action="edit"]').forEach(btn => btn.addEventListener('click', onEdit));
        container.querySelectorAll('button[data-action="delete"]').forEach(btn => btn.addEventListener('click', onDelete));
      }

      function renderPagination(payload){
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        if(!payload) return;

        const createLi = (label, url, disabled=false, active=false) => {
          const li = document.createElement('li'); li.className = 'page-item' + (disabled? ' disabled': '') + (active? ' active': '');
          const a = document.createElement('a'); a.className = 'page-link'; a.href = '#'; a.textContent = label;
          a.addEventListener('click', (e)=>{ e.preventDefault(); if(url) loadBikes(url); });
          li.appendChild(a); return li;
        };

        // previous
        pagination.appendChild(createLi('Previous', payload.previous, !payload.previous));

        // simple page numbers: derive from next/previous if available or use page query
        if(payload.count){
          const pageSize = payload.results.length || 6;
          const pages = Math.ceil(payload.count / pageSize);
          for(let i=1;i<=pages;i++){
            const url = new URL(API_BASE);
            url.searchParams.set('page', i);
            pagination.appendChild(createLi(i, url.toString(), false, false));
          }
        }

        // next
        pagination.appendChild(createLi('Next', payload.next, !payload.next));
      }

      async function onEdit(e){
        const id = e.currentTarget.dataset.id;
        const res = await fetch(`${API_BASE}${id}/`);
        const data = await res.json();
        document.getElementById('bikeId').value = data.id;
        document.getElementById('company').value = data.company;
        document.getElementById('model').value = data.model;
        document.getElementById('year').value = data.year;
        document.getElementById('description').value = data.description;
        document.getElementById('bikeModalTitle').textContent = 'Edit Bike';
        bikeModal.show();
      }

      async function onDelete(e){
        const id = e.currentTarget.dataset.id;
        if(!confirm('Delete this bike?')) return;
        const res = await fetch(`${API_BASE}${id}/`, { method: 'DELETE', headers: getAuthHeaders() });
        if(res.status === 204){ loadBikes(currentPageUrl); }
        else alert('Delete failed');
      }

      async function saveBike(){
        const id = document.getElementById('bikeId').value;
        const payload = {
          company: document.getElementById('company').value,
          model: document.getElementById('model').value,
          year: parseInt(document.getElementById('year').value,10),
          description: document.getElementById('description').value,
        };

        try{
          let res;
          if(id){
            res = await fetch(`${API_BASE}${id}/`, { method: 'PUT', headers: {...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          } else {
            res = await fetch(API_BASE, { method: 'POST', headers: {...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          }

          if(res.ok){
            bikeModal.hide();
            clearForm();
            loadBikes(currentPageUrl);
          } else {
            const err = await res.json();
            alert('Save failed: ' + JSON.stringify(err));
          }
        }catch(err){ console.error(err); alert('Save failed'); }
      }

      function clearForm(){
        document.getElementById('bikeId').value = '';
        document.getElementById('company').value = '';
        document.getElementById('model').value = '';
        document.getElementById('year').value = '';
        document.getElementById('description').value = '';
      }

      // basic HTML escape
      function escapeHtml(unsafe) {
        return String(unsafe)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // initial load
      function getAuthHeaders(){
        {% if access %}
        return { 'Authorization': 'Bearer {{ access }}' };
        {% else %}
        return {};
        {% endif %}
      }

      // If server provided initial bikes, attach listeners to those buttons.
      document.addEventListener('DOMContentLoaded', () => {
        {% if bikes %}
          document.querySelectorAll('#cards button[data-action="edit"]').forEach(btn => btn.addEventListener('click', onEdit));
          document.querySelectorAll('#cards button[data-action="delete"]').forEach(btn => btn.addEventListener('click', onDelete));
        {% else %}
          loadBikes();
        {% endif %}
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
